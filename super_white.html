<!-- START CHUNK 1 — head + css -->
<head>
<meta charset="UTF-8">
<title>Supervisor Dashboard</title>
<style>
    body { margin:0; font-family:Arial, sans-serif; background:#f4f6f9; }
    .header { background:white; padding:20px 30px; font-size:28px; font-weight:bold; color:#1b4cd4; border-bottom:1px solid #ddd; }

    .grid-kpi { display:grid; grid-template-columns:repeat(4,1fr); gap:20px; margin:30px; }
    .kpi { background:white; padding:25px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; }
    .kpi .value { font-size:40px; font-weight:bold; margin-bottom:5px; }

    .charts { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin:0 30px; }
    .chart-card { background:white; padding:12px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }

    .tables { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin:30px; }
    table { width:100%; border-collapse:collapse; font-size:14px; background:white; }
    th, td { padding:10px; border-bottom:1px solid #ddd; }
    th { background:#f0f3f7; text-align:left; }
</style>
</head>
<!-- END CHUNK 1 -->
<!-- START CHUNK 2 — KPI row dynamic -->
<div class="grid-kpi">
    <div class="kpi">
        <div class="value" id="kpiLorriesToday">0</div>
        Lorries Today
    </div>
    <div class="kpi">
        <div class="value" id="kpiReleased">0</div>
        Released
    </div>
    <div class="kpi">
        <div class="value" id="kpiAvgWait">0 mins</div>
        Avg Wait Time
    </div>
    <div class="kpi">
        <div class="value" id="kpiOverdue">0</div>
        Overdue > 1hr
    </div>
</div>
<!-- END CHUNK 2 -->
<!-- START CHUNK 3 — charts (OVERDUE BUCKET CHART REPLACES DONUT) -->

<div class="charts">

    <!-- Chart 1 — Check-ins per Hour -->
    <div class="chart-card">
        <h3>Check-ins Per Hour</h3>
        <canvas id="chartCheckins"></canvas>
    </div>

    <!-- Chart 2 — Overdue Buckets (Traffic Light) -->
    <div class="chart-card">
        <h3>Overdue Buckets</h3>
        <canvas id="chartOverdueBuckets"></canvas>
    </div>

</div>

<!-- END CHUNK 3 -->

<!-- START CHUNK 4 — tables dynamic -->
<div class="tables">
    <div class="table-card">
        <h3>Top 10 Longest Waits</h3>
        <table id="tblWaits">
            <tr><th>Reg</th><th>Wait</th><th>PO</th></tr>
        </table>
    </div>

    <div class="table-card">
        <h3>Live Activity Feed</h3>
        <table id="tblActivity">
            <tr><th>Time</th><th>Event</th></tr>
        </table>
    </div>
</div>
<!-- END CHUNK 4 -->
<!-- ========================================================= -->
<!-- =====================  CHUNK 5  ========================= -->
<!-- ===  COMPLETE SUPABASE + KPI + TABLES + CHARTS + REFRESH === -->
<!-- ========================================================= -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

/* ============================================================
   =============== 5A — SUPABASE CLIENT SETUP ==================
   ============================================================ */
const db = supabase.createClient(
  "https://splcucorowqjxeeseolq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbGN1Y29yb3dxanhlZXNlb2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTExMjUsImV4cCI6MjA3ODYyNzEyNX0.R-Fm04UtBOr9OBWHnS1fhk6SnfSm7f3ZrFrQdzO1Q4Y"
);


/* ============================================================
   =================== 5B — KPI LOADER =========================
   ============================================================ */
async function loadKPIs() {
    const today = new Date().toISOString().slice(0,10);

    const { data: inToday } = await db
        .from("vehicles")
        .select("id")
        .gte("check_in_time", today);

    const { data: releasedToday } = await db
        .from("vehicles")
        .select("id")
        .eq("status","released")
        .gte("release_time", today);

    const { data: waiting } = await db
        .from("vehicles")
        .select("check_in_time")
        .eq("status","waiting");

    const { data: active } = await db
        .from("vehicles")
        .select("check_in_time, status")
        .in("status", ["waiting","notified"]);

    const overdue = active.filter(v =>
        (Date.now() - new Date(v.check_in_time)) > 60*60000
    ).length;

    let avgWait = 0;
    if (waiting?.length > 0) {
        const total = waiting.reduce((sum,v) =>
            sum + (Date.now() - new Date(v.check_in_time)), 0
        );
        avgWait = Math.floor(total / waiting.length / 60000);
    }

    document.getElementById("kpiLorriesToday").textContent = inToday?.length || 0;
    document.getElementById("kpiReleased").textContent = releasedToday?.length || 0;
    document.getElementById("kpiAvgWait").textContent = `${avgWait} mins`;
    document.getElementById("kpiOverdue").textContent = overdue;
}


/* ============================================================
   ============= 5C — TABLES SECTION ===========================
   ============================================================ */
let loadingWaits = false;

async function loadTopWaits() {
    if (loadingWaits) return;
    loadingWaits = true;

    const table = document.getElementById("tblWaits");
    table.innerHTML = `
        <tr><th>Reg</th><th>Wait</th><th>PO</th></tr>
    `;

    const { data } = await db
        .from("vehicles")
        .select("registration, po_ref, check_in_time")
        .eq("status","waiting");

    if (!data || data.length === 0) {
        table.innerHTML += `<tr><td colspan="3">No waiting vehicles</td></tr>`;
        loadingWaits = false;
        return;
    }

    const ranked = data
        .map(v => ({
            ...v,
            wait: Math.floor((Date.now() - new Date(v.check_in_time)) / 60000)
        }))
        .sort((a,b) => b.wait - a.wait)
        .slice(0,10);

    ranked.forEach(v => {
        table.innerHTML += `
            <tr>
                <td>${v.registration}</td>
                <td>${v.wait} mins</td>
                <td>${v.po_ref || "-"}</td>
            </tr>`;
    });

    loadingWaits = false;
}


async function loadActivity() {
    const tbl = document.getElementById("tblActivity");

    tbl.innerHTML = `
        <tr><th>Time</th><th>Event</th></tr>
    `;

    const { data } = await db
        .from("actions_log")
        .select(`
            timestamp,
            action,
            operators(name),
            vehicles(registration, po_ref)
        `)
        .order("timestamp", { ascending:false })
        .limit(10);

    if (!data || data.length === 0) {
        tbl.innerHTML += `<tr><td colspan="2">No recent activity</td></tr>`;
        return;
    }

    data.forEach(a => {
        const t = new Date(a.timestamp).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"});
        const who = a.operators?.name || "unknown";
        const reg = a.vehicles?.registration || "?";

        tbl.innerHTML += `
            <tr>
                <td>${t}</td>
                <td>${a.action} – ${reg} by ${who}</td>
            </tr>`;
    });
}


/* ============================================================
   ================= 5D — CHARTS SECTION ======================
   ============================================================ */

let chart1 = null;
let chartBuckets = null;

async function loadCharts() {

    // ----------- CHART 1 — CHECK-IN PER HOUR -----------
    const { data: checkins } = await db
        .from("vehicles")
        .select("check_in_time");

    const bucketsHourly = {};
    checkins.forEach(v => {
        const h = new Date(v.check_in_time).getHours();
        bucketsHourly[h] = (bucketsHourly[h] || 0) + 1;
    });

    if (chart1) chart1.destroy();
    chart1 = new Chart(document.getElementById("chartCheckins"), {
        type: "line",
        data: {
            labels: Object.keys(bucketsHourly),
            datasets: [{
                label: "Check-ins",
                data: Object.values(bucketsHourly),
                borderWidth: 2
            }]
        }
    });


    /* ----- OVERDUE BUCKETS (Corrected for due_time) ----- */

const { data: active } = await db
    .from("vehicles")
    .select("check_in_time, due_time, status")
    .in("status", ["waiting","notified"]);

let b0_30 = 0, b30_60 = 0, b60_120 = 0, b120plus = 0;

active.forEach(v => {
    const now = Date.now();
    const due = new Date(v.due_time).getTime();
    let minutes_overdue = Math.floor((now - due) / 60000);

    // If still before due time, NOT overdue → bucket as 0–30
    if (minutes_overdue < 0) {
        b0_30++;
        return;
    }

    // Otherwise bucket by late time
    if (minutes_overdue < 30) b0_30++;
    else if (minutes_overdue < 60) b30_60++;
    else if (minutes_overdue < 120) b60_120++;
    else b120plus++;
});


    const labels = ["0–30m","30–60m","60–120m","120+m"];
    const values = [b0_30, b30_60, b60_120, b120plus];
    const colours = ["#4CAF50","#FFC107","#FF5722","#C62828"];

    if (chartBuckets) chartBuckets.destroy();
    chartBuckets = new Chart(document.getElementById("chartOverdueBuckets"), {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: "Active Vehicles",
                data: values,
                backgroundColor: colours
            }]
        },
        options: {
            scales: { y: { beginAtZero: true }}
        }
    });
}


/* ============================================================
   ================== 5E — AUTO REFRESH ========================
   ============================================================ */

function runAll() {
    loadKPIs();
    loadTopWaits();
    loadActivity();
    loadCharts();
}

runAll();  // initial load
setInterval(loadVehicle, 10000); // refresh every 5 secs (testing)

</script>

<!-- ===================== END CHUNK 5 ======================= -->




<!-- START CHUNK 6 — close document -->
</body>
</html>
<!-- END CHUNK 6 -->

