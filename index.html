<!-- START SECTION A -->

<!-- START A1 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Warehouse Pager Dashboard</title>
<!-- END A1 -->

<!-- START A2 -->
<style>
    body {
        margin: 0;
        background: #121212;
        font-family: Arial, sans-serif;
        color: #e6e6e6;
    }
    * {
        box-sizing: border-box;
    }
</style>
<!-- END A2 -->

<!-- START A3 -->
<style>
    .add-btn {
        background:#1b4cd4;
        color:white;
        padding:10px 18px;
        border-radius:8px;
        border:none;
        font-size:16px;
        cursor:pointer;
        margin-right:10px;
    }

    /* DARK ADD LORRY PANEL */
    .slide-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;

        /* Increased height to support dropdown */
        min-height: 420px;

        background: #1c1c1c;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        padding: 20px 30px;

        /* FIX: push completely off-screen */
        transform: translateY(calc(-100% - 40px));

        transition: transform 0.8s ease;
        z-index: 999;
        color: #fff;
    }

    .panel-visible { transform: translateY(0); }

    .panel-title {
        font-size: 22px;
        color: #1b8cff;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .form-row {
        display: flex;
        gap: 20px;
        margin-top: 10px;
    }

    input, textarea, select {
        padding: 12px;
        width: 100%;
        border: 1px solid #444;
        border-radius: 8px;
        font-size: 16px;
        background: #2a2a2a;
        color: #fff;
    }

    .submit-btn {
        padding: 12px 20px;
        background: #1b8cff;
        color: white;
        border-radius: 6px;
        margin-top: 15px;
        cursor: pointer;
        text-align: center;
        font-weight: bold;
    }
</style>
<!-- END A3 -->

<!-- START A4 -->
<style>
    /* HEADER */
    .header {
        background: #1b1b1b;
        padding: 20px 30px;
        font-size: 32px;
        font-weight: bold;
        color: #f1c40f;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .header-left { flex: 1; }

    .header-clock {
        font-size: 50px;
        font-weight: bold;
        color: #ffffff;
        text-align: center;
        flex: 1;
    }

    .header-right {
        font-size: 16px;
        opacity: 0.85;
        text-align: right;
        flex: 1;
        display: flex;
        justify-content: flex-end;
        gap: 20px;
        color: #fff;
    }

    /* STATS */
    .grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin: 25px 30px;
    }

    .stat {
        background: #1f1f1f;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #303030;
        text-align: center;
        color: #e6e6e6;
    }

    .stat .value {
        font-size: 42px;
        font-weight: bold;
        margin-bottom: 6px;
        color: #f1c40f;
    }

    /* LAYOUT */
    .main-split {
        display: flex;
        gap: 20px;
        margin: 0 30px 30px 30px;
    }

    .left-side  { flex: 6; }
    .right-side { flex: 4; }

    .activity-panel {
        background: #1c1c1c;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #303030;
        min-height: 400px;
        font-size: 20px;
        color: #e6e6e6;
    }

    .queue-container {
        background: #1c1c1c;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #303030;
        color: #e6e6e6;
    }

    .queue-header {
        font-size: 24px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        color: #ffffff;
    }
</style>
<!-- END A4 -->
<!-- START A5 -->
<style>

    /* BASE ENTRY CARD */
    .entry {
        padding: 15px;
        margin-bottom: 14px;
        border-radius: 8px;
        border-left: 50px solid transparent;
        background: #252525;
        position: relative;
        font-size: 18px;
        color: #e6e6e6;
        transition: 0.3s;
    }

    /* NORMAL COLOURS */
    .green { border-left-color: #22c55e; }
    .amber { border-left-color: #f59e0b; }
    .red { border-left-color: #ef4444; }
    .red2 { border-left-color: #7f1d1d; }

    /* EXPORT SUPER HIGHLIGHT MODE */
    .export-card {
        border-left-color: #1b8cff !important;     /* big blue bar */
        background: linear-gradient(90deg,
                    rgba(27,140,255,0.20),
                    rgba(27,140,255,0.05)) !important;
        box-shadow: 0 0 22px rgba(27,140,255,0.55),
                    0 0 10px rgba(27,140,255,0.35) !important;
        animation: exportPulse 1.8s infinite ease-in-out;
    }

    @keyframes exportPulse {
        0%   { box-shadow: 0 0 14px rgba(27,140,255,0.45); }
        50%  { box-shadow: 0 0 28px rgba(27,140,255,0.85); }
        100% { box-shadow: 0 0 14px rgba(27,140,255,0.45); }
    }

    /* EXPORT BADGE */
    .export-banner {
        display: inline-block;
        background: #1b8cff;
        color: #fff;
        padding: 3px 10px;
        font-size: 13px;
        font-weight: bold;
        border-radius: 6px;
        margin-bottom: 8px;
    }

</style>
<!-- END A5 -->

<!-- START A6 -->
</head>
<body>
<!-- END A6 -->

<!-- END SECTION A -->

<!-- START SECTION B -->
<!-- START B1 -->
<div id="panel" class="slide-panel">

    <div class="panel-title">Add New Lorry</div>

    <!-- NEW: Expected Loads Dropdown -->
    <label style="color:#ccc; margin-top:10px;">Expected Loads</label>
    <select id="prebookSelect"
        onchange="applyPrebook()"
        style="
            width:100%;
            padding:12px;
            background:#2a2a2a;
            color:#fff;
            border:1px solid #444;
            border-radius:8px;
            font-size:16px;
            margin-bottom:12px;
        ">
        <option value="">-- Select Pre-Booked Load --</option>
    </select>

    <div class="form-row">
        <input type="text" id="poInput" placeholder="PO / Reference Number">
        <input type="text" id="regInput" placeholder="Registration">
    </div>

    <div class="form-row">
        <input type="number" id="pagerInput" placeholder="Pager Number">

        <select id="quotedInput">
            <option value="30">30 mins</option>
            <option value="45">45 mins</option>
            <option value="60" selected>60 mins</option>
            <option value="90">90 mins</option>
            <option value="120">120 mins</option>
        </select>
    </div>

    <div class="form-row">
        <textarea id="notesInput" placeholder="Notes"></textarea>
    </div>

    <div id="submitBtn" class="submit-btn" onclick="submitVehicle()">Submit</div>
</div>
<!-- END B1 -->


<!-- START B2 -->
<div id="header" class="header">

    <div class="header-left">DCS Lorry Booking System</div>

    <div id="clock" class="header-clock">--:--</div>

    <div class="header-right">
        <button class="add-btn" onclick="togglePanel()">Add Vehicle</button>

        <!-- AVATAR + DROPDOWN -->
        <div style="position:relative;">
            <div id="avatarBtn"
                style="
                    width:42px;
                    height:42px;
                    border-radius:50%;
                    background:#2a2a2a;
                    border:1px solid #444;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    font-size:8px;
                    cursor:pointer;
                    user-select:none;
                ">
                ??
            </div>

            <div id="avatarMenu"
                style="
                    position:absolute;
                    top:48px;
                    right:0;
                    background:#1c1c1c;
                    border:1px solid #333;
                    border-radius:8px;
                    width:170px;
                    padding:8px 0;
                    display:none;
                    z-index:9999;
                ">
                <div id="menuName"
                    style="
                        padding:10px 14px;
                        color:#ddd;
                        border-bottom:1px solid #333;
                        font-size:14px;
                    ">
                    Loading...
                </div>

                <div onclick="logoutUser()"
                    style="
                        padding:10px 14px;
                        color:#fff;
                        cursor:pointer;
                        font-size:16px;
                    ">
                    Logout
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// Logout
function logoutUser() {
    localStorage.removeItem("operator_id");
    window.location.href = "login.html";
}

// Avatar dropdown toggle
document.addEventListener("click", e => {
    const btn = document.getElementById("avatarBtn");
    const menu = document.getElementById("avatarMenu");

    if (btn.contains(e.target)) {
        menu.style.display = (menu.style.display === "block" ? "none" : "block");
    } else if (!menu.contains(e.target)) {
        menu.style.display = "none";
    }
});

// Inject operator name + initials
(async () => {
    const opId = localStorage.getItem("operator_id");
    if (!opId) return;

    const { data: op } = await db
        .from("operators")
        .select("*")
        .eq("id", opId)
        .single();

    const opName = op?.name || "Unknown";
    document.getElementById("menuName").textContent = opName;

    const initials = opName
        .split(" ")
        .map(x => x[0]?.toUpperCase() || "")
        .join("")
        .slice(0, 2);

    document.getElementById("avatarBtn").textContent = initials;
})();
</script>
<!-- END B2 -->


<!-- START B3 -->
<div class="grid">

    <div class="stat">
        <div class="value" id="statIn">0</div>
        Lorries Booked In<br>
        <span style="font-size:14px;opacity:0.6;">Last 8 hours</span>
    </div>

    <div class="stat">
        <div class="value" id="statOut">0</div>
        Lorries Booked Out<br>
        <span style="font-size:14px;opacity:0.6;">Last 8 hours</span>
    </div>

    <div class="stat">
        <div class="value" id="statDiff">0</div>
        Difference<br>
        <span style="font-size:14px;opacity:0.6;">In - Out</span>
    </div>

    <div class="stat">
        <div class="value" id="statAvg">0 mins</div>
        Average Waiting Time<br>
        <span style="font-size:14px;opacity:0.6;">Across active</span>
    </div>

</div>
<!-- END B3 -->


<!-- START B4 -->
<div class="main-split">

    <div class="left-side">
        <div class="queue-container">
            <div class="queue-header">
                <span>Active Queue</span>
                <span class="queue-count" style="color:#bbb;">Loading...</span>
            </div>

            <!-- Queue items inserted by renderQueue() -->
        </div>
    </div>

    <div class="right-side">
        <div class="activity-panel">
            Loading activity...
        </div>
    </div>

</div>
<!-- END B4 -->


<!-- START B5 -->
<div id="searchPanel" style="color:white; display:none;">
    <h3>Search Vehicle</h3>

    <input 
        id="searchInput"
        type="text"
        placeholder="Enter registration…"
        onkeyup="searchVehicles()"
        style="
            width:100%;
            padding:12px;
            background:#1f1f1f;
            color:#fff;
            border:1px solid #444;
            border-radius:8px;
        "
    >

    <div id="searchResults" style="margin-top:15px; font-size:16px; color:#ddd;"></div>
</div>
<!-- END B5 -->


<!-- START B6 -->
<div id="editModalOverlay" style="
    position:fixed;
    top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.6);
    display:none;
    z-index:9999;
">
    <div id="editModal" style="
        background:#1c1c1c;
        color:#fff;
        width:420px;
        margin:80px auto;
        padding:25px;
        border-radius:12px;
        border:1px solid #333;
    ">
        <!-- Modal content injected in D4 -->
    </div>
</div>
<!-- END B6 -->

<!-- END SECTION B -->
<!-- START SECTION C -->

<!-- START C1 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = "https://splcucorowqjxeeseolq.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbGN1Y29yb3dxanhlZXNlb2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTExMjUsImV4cCI6MjA3ODYyNzEyNX0.R-Fm04UtBOr9OBWHnS1fhk6SnfSm7f3ZrFrQdzO1Q4Y";
const db = supabase.createClient(supabaseUrl, supabaseKey);
</script>
<!-- END C1 -->

// START C2 — Operator Loader (fixed avatar)
<script>
(async () => {
    const opId = localStorage.getItem("operator_id");
    if (!opId) { 
        window.location.href = "login.html"; 
        return; 
    }

    const { data: op } = await db
        .from("operators")
        .select("name")
        .eq("id", opId)
        .single();

    const opName = op?.name || "Unknown";

    // Avatar menu name
    if (document.getElementById("menuName")) {
        document.getElementById("menuName").textContent = opName;
    }

    // Avatar initials
    if (document.getElementById("avatarBtn")) {
        const initials = opName
            .split(" ")
            .map(x => x[0]?.toUpperCase() || "")
            .join("")
            .slice(0, 2);

        document.getElementById("avatarBtn").textContent = initials;
    }
})();
</script>
// END C2 — Operator Loader (fixed avatar)

<!-- START C3 — submitVehicle (HTML-safe, QR auto-launch) -->
<script>
let submitting = false;
let prebookCache = [];
let prebookExportFlag = false;

function togglePanel() {
    document.getElementById("panel").classList.toggle("panel-visible");
    loadPrebooks();
}

async function loadPrebooks() {
    const sel = document.getElementById("prebookSelect");
    sel.innerHTML = "<option value=''>-- Select Pre-Booked Load --</option>";

    const { data } = await db
        .from("prebookings")
        .select("*")
        .eq("consumed", false)
        .order("expected_date", { ascending: true })
        .order("expected_time", { ascending: true });

    prebookCache = data || [];

    prebookCache.forEach(p => {
        const label =
            `${p.po_ref} — ${p.registration || "No Reg"} — ${p.expected_date || ""} ${p.expected_time?.slice(0,5) || ""}` +
            (p.is_export ? " — EXPORT" : "");

        sel.innerHTML += `<option value="${p.id}">${label}</option>`;
    });
}

function applyPrebook() {
    const id = document.getElementById("prebookSelect").value;
    if (!id) return;

    const pb = prebookCache.find(x => x.id === id);
    if (!pb) return;

    document.getElementById("poInput").value = pb.po_ref || "";
    document.getElementById("regInput").value = pb.registration || "";
    document.getElementById("notesInput").value = pb.notes || "";

    prebookExportFlag = pb.is_export === true;
}

async function submitVehicle() {
    if (submitting) return;
    submitting = true;

    const btn = document.getElementById("submitBtn");
    btn.style.pointerEvents = "none";
    btn.style.opacity = "0.5";

    let reg = document.getElementById("regInput").value.trim();
    let po = document.getElementById("poInput").value.trim();
    let pager = parseInt(document.getElementById("pagerInput").value);
    let notes = document.getElementById("notesInput").value.trim();
    let quoted = parseInt(document.getElementById("quotedInput").value);

    reg = reg.replace(/\s+/g, "").toUpperCase();
    if (!reg) {
        alert("Registration required");
        submitting = false;
        btn.style.pointerEvents = "auto";
        btn.style.opacity = "1";
        return;
    }

    const opId = localStorage.getItem("operator_id");
    if (!opId) {
        window.location.href = "login.html";
        return;
    }

    const now = new Date().toISOString();
    const due = new Date(Date.now() + quoted * 60000).toISOString();

    /* insert vehicle */
    const { data, error } = await db
        .from("vehicles")
        .insert({
            registration: reg,
            po_ref: po,
            pager_number: pager,
            notes: notes,
            quoted_minutes: quoted,
            due_time: due,
            status: "waiting",
            check_in_time: now,
            operator_id: opId,
            classification: prebookExportFlag ? "export" : "normal"
        })
        .select();

    if (error) {
        alert("Error: " + error.message);
        submitting = false;
        btn.style.pointerEvents = "auto";
        btn.style.opacity = "1";
        return;
    }

    const vehicleId = data[0].id;

    /* log action */
    await db.from("actions_log").insert({
        vehicle_id: vehicleId,
        operator_id: opId,
        action: "check_in",
        details: {}
    });

    /* mark prebook consumed */
    const selected = document.getElementById("prebookSelect").value;
    if (selected) {
        await db
            .from("prebookings")
            .update({ consumed: true })
            .eq("id", selected);
    }

    /* auto-launch QR screen in new tab */
    window.open(`qr-screen.html?uid=${vehicleId}`, "_blank");

    /* refresh dashboard */
    loadQueue();
    loadStats();
    loadActivity();

    submitting = false;
    btn.style.pointerEvents = "auto";
    btn.style.opacity = "1";
    prebookExportFlag = false;

    togglePanel();
}
</script>
<!-- END C3 — submitVehicle (HTML-safe, QR auto-launch) -->


<!-- START C4 -->
<script>
async function loadQueue() {
    const { data } = await db
        .from("vehicles")
        .select(`
            id,
            registration,
            po_ref,
            pager_number,
            notes,
            check_in_time,
            due_time,
            quoted_minutes,
            status,
            classification
        `)
        .in("status", ["waiting", "notified"])
        .order("check_in_time", { ascending: true });

    // fail-safe: ensure an array is passed
    renderQueue(data || []);
}
</script>
<!-- END C4 -->
<!-- START C5 -->
<script>
function renderQueue(list) {
    const container = document.querySelector(".queue-container");

    container.innerHTML = `
        <div class="queue-header">
            <span>Active Queue</span>
            <span class="queue-count">${list.length} vehicles active</span>
        </div>
    `;

    if (!list || list.length === 0) {
        container.innerHTML += `<div style="padding:30px;text-align:center;color:#777;">No active vehicles</div>`;
        return;
    }

    list.forEach(v => {

        const checkIn = new Date(v.check_in_time);
        const due = new Date(v.due_time);
        const now = new Date();

        let overdue = Math.floor((now - due) / 60000);
        if (overdue < 0) overdue = 0;

        let colour = "green";
        if (now >= due) colour = "amber";
        if (overdue >= 30) colour = "red";
        if (overdue >= 180) colour = "red2";

        const isExport = v.classification === "export";
        const cardClass = isExport ? "export-card" : colour;

        const dueText = due.toLocaleTimeString("en-GB", { hour:"2-digit", minute:"2-digit" });

        container.innerHTML += `
            <div class="entry ${cardClass}">

                <div class="entry-top" onclick="openModalEditor('${v.id}')">

                    <div>

                        ${isExport ? `
                            <div class="export-banner">EXPORT LOAD</div>
                        ` : ""}

                        <strong>${v.registration}</strong><br>
                        <span>${v.po_ref || "No PO"}</span><br>

                        <span style="font-size:11px;opacity:0.7;">Due at ${dueText}</span>
                        <div class="pager-badge">Pager #${v.pager_number || "-"}</div>

                        <div id="notes-${v.id}"
                             class="notes-text"
                             onclick="event.stopPropagation(); enableNotesEdit('${v.id}', \`${v.notes || ''}\`)">
                            ${v.notes ? v.notes : "<i>Click to add notes</i>"}
                        </div>

                    </div>

                    <div style="text-align:right;">
                        <div>
                            ${v.status === "notified"
                                ? "<strong style='color:#1b4cd4;'>Notified</strong>"
                                : (overdue > 0
                                    ? overdue+" mins overdue"
                                    : "On time")}
                        </div>
                        <div style="font-size:12px;opacity:0.7;">
                            In: ${checkIn.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})}
                        </div>
                    </div>

                </div>

                <div class="entry-actions">
                    <button class="action-btn notify-btn" onclick="notifyVehicle('${v.id}')">Notify</button>
                    <button class="action-btn complete-btn" onclick="completeVehicle('${v.id}')">Complete</button>
                    <button class="action-btn" style="background:#777;" onclick="undoVehicle('${v.id}')">Undo</button>
                </div>

            </div>
        `;
    });
}
</script>
<!-- END C5 -->

<!-- START C6 -->
<script>
function enableNotesEdit(vehicleId, oldNotes) {
    const notesEl = document.getElementById("notes-" + vehicleId);
    notesEl.innerHTML = `
        <input id="notesInput-${vehicleId}" class="notes-input" value="${oldNotes || ''}">
    `;

    const input = document.getElementById("notesInput-" + vehicleId);
    input.focus();

    input.addEventListener("blur", () => saveNotes(vehicleId));
    input.addEventListener("keydown", e => { if (e.key === "Enter") saveNotes(vehicleId); });
}

async function saveNotes(vehicleId) {
    const input = document.getElementById("notesInput-" + vehicleId);
    if (!input) return;

    const newNotes = input.value.trim();
    const opId = localStorage.getItem("operator_id");

    await db.from("vehicles").update({
        notes: newNotes,
        operator_id: opId
    }).eq("id", vehicleId);

    await db.from("actions_log").insert({
        vehicle_id: vehicleId,
        operator_id: opId,
        action: "notes_edit",
        details: { notes: newNotes }
    });

    loadQueue();
    loadActivity();
}
</script>
<!-- END C6 -->


<!-- START C7 — Complete/Notify/Undo -->
<script>
async function notifyVehicle(id) {
    const opId = localStorage.getItem("operator_id");
    if (!opId) { window.location.href = "login.html"; return; }

    const now = new Date().toISOString();

    await db.from("vehicles").update({
        status: "notified",
        notify_time: now,
        operator_id: opId
    }).eq("id", id);

    await db.from("actions_log").insert({
        vehicle_id: id,
        operator_id: opId,
        action: "notified",
        details: {}
    });

    loadQueue();
    loadStats();
    loadActivity();
}

async function completeVehicle(id) {
    const opId = localStorage.getItem("operator_id");
    if (!opId) { window.location.href = "login.html"; return; }

    const now = new Date().toISOString();

    await db.from("vehicles").update({
        status: "released",
        release_time: now,
        operator_id: opId
    }).eq("id", id);

    await db.from("actions_log").insert({
        vehicle_id: id,
        operator_id: opId,
        action: "completed",   // UPDATED
        details: {}
    });

    loadQueue();
    loadStats();
    loadActivity();
}

async function undoVehicle(id) {
    const opId = localStorage.getItem("operator_id");
    if (!opId) { window.location.href = "login.html"; return; }

    await db.from("vehicles").update({
        status: "waiting",
        notify_time: null,
        release_time: null,
        operator_id: opId
    }).eq("id", id);

    await db.from("actions_log").insert({
        vehicle_id: id,
        operator_id: opId,
        action: "undo",
        details: { reverted: true }
    });

    loadQueue();
    loadStats();
    loadActivity();
}
</script>
<!-- END C7 — Complete/Notify/Undo -->



<!-- END SECTION C -->
<!-- START D1 — Load Activity (400-safe version) -->
<script>
async function loadActivity() {
    const panel = document.querySelector(".activity-panel");
    panel.innerHTML = `<h3 style="color:#fff;">Recent Activity</h3><hr style="border-color:#444;">`;

    // Step 1 — get raw log rows only
    const { data: logs, error } = await db
        .from("actions_log")
        .select("timestamp, action, operator_id, vehicle_id")
        .order("timestamp", { ascending: false })
        .limit(20);

    if (error) {
        panel.innerHTML += `<div style="color:#f55;">Failed to load activity</div>`;
        return;
    }

    if (!logs || logs.length === 0) {
        panel.innerHTML += `<div style="color:#888;">No recent actions</div>`;
        return;
    }

    // Step 2 — lookup operator + vehicle names
    for (const a of logs) {
        let name = "unknown";
        let reg = "unknown";
        let po  = "";

        if (a.operator_id) {
            const { data: op } = await db
                .from("operators")
                .select("name")
                .eq("id", a.operator_id)
                .single();

            if (op) name = op.name;
        }

        if (a.vehicle_id) {
            const { data: v } = await db
                .from("vehicles")
                .select("registration, po_ref")
                .eq("id", a.vehicle_id)
                .single();

            if (v) {
                reg = v.registration || "unknown";
                po  = v.po_ref || "";
            }
        }

        const t = new Date(a.timestamp)
            .toLocaleTimeString("en-GB", { hour:"2-digit", minute:"2-digit", second:"2-digit" });

        let label = a.action;
        if (label === "check_in") label = "checked in";
        if (label === "notified") label = "notified";
        if (label === "completed") label = "completed";
        if (label === "undo") label = "undo";
        if (label === "modal_edit") label = "edited";

        panel.innerHTML += `
            <div style="margin-bottom:12px; color:#ddd;">
                <strong style="font-size:18px;">${reg}</strong>
                <span style="opacity:0.6; font-size:14px;">${po}</span><br>
                <span style="opacity:0.75; font-size:14px;">
                    ${label} by ${name} — ${t}
                </span>
            </div>
        `;
    }
}
</script>
<!-- END D1 — Load Activity (400-safe version) -->

<!-- START D2 -->
<script>
async function loadStats() {
    const since = new Date(Date.now() - 8*60*60*1000).toISOString();

    const { data: inRows } = await db
        .from("vehicles")
        .select("id")
        .gte("check_in_time", since);

    const { data: outRows } = await db
        .from("vehicles")
        .select("id")
        .eq("status", "released")
        .gte("release_time", since);

    const { data: waitingRows } = await db
        .from("vehicles")
        .select("check_in_time")
        .eq("status", "waiting");

    const inCount = inRows?.length || 0;
    const outCount = outRows?.length || 0;
    const diff = inCount - outCount;

    let avg = 0;
    if (waitingRows && waitingRows.length > 0) {
        const total = waitingRows.reduce((sum, v)=>
            sum + (Date.now() - new Date(v.check_in_time)),
        0);
        avg = total / waitingRows.length;
    }
    const avgMins = Math.floor(avg / 60000);

    document.getElementById("statIn").textContent = inCount;
    document.getElementById("statOut").textContent = outCount;
    document.getElementById("statDiff").textContent = diff;
    document.getElementById("statAvg").textContent = `${avgMins} mins`;
}
</script>
<!-- END D2 -->


<!-- START D3 -->
<script>
async function searchVehicles() {
    const q = document.getElementById("searchInput").value.trim().toUpperCase();
    const box = document.getElementById("searchResults");

    if (q.length < 2) {
        box.innerHTML = `<i style="color:#777;">Type 2+ characters…</i>`;
        return;
    }

    const { data } = await db
        .from("vehicles")
        .select("*")
        .ilike("registration", `%${q}%`)
        .order("check_in_time", { ascending: false });

    if (!data || data.length === 0) {
        box.innerHTML = `<i style="color:#777;">No matches</i>`;
        return;
    }

    let html = "";
    data.forEach(v => {
        html += `
            <div style="
                padding:12px;
                border:1px solid #444;
                border-radius:8px;
                margin-bottom:12px;
                background:#1f1f1f;
                cursor:pointer;
                color:#fff;
            " onclick="openModalEditor('${v.id}')">
                <strong>${v.registration}</strong> — ${v.status}<br>
                PO: ${v.po_ref || "-"}<br>
                Pager: ${v.pager_number || "-"}
            </div>
        `;
    });

    box.innerHTML = html;
}
</script>
<!-- END D3 -->


<!-- START D4 -->
<script>
async function openModalEditor(id) {
    const { data: v } = await db
        .from("vehicles")
        .select("*")
        .eq("id", id)
        .single();

    const modal = document.getElementById("editModal");
    const overlay = document.getElementById("editModalOverlay");

    modal.innerHTML = `
        <h2 style="color:#fff;">Edit ${v.registration}</h2>

        <label style="color:#bbb;">Status:</label><br>
        <select id="edit-status-${id}" style="
            padding:10px; margin:6px 0 16px 0; 
            border-radius:6px; 
            background:#1c1c1c; 
            color:#fff;
            border:1px solid #444; width:180px;">
            <option value="waiting"  ${v.status==="waiting"?"selected":""}>waiting</option>
            <option value="notified" ${v.status==="notified"?"selected":""}>notified</option>
            <option value="released" ${v.status==="released"?"selected":""}>released</option>
        </select>

        <label style="color:#bbb;">PO / Reference:</label>
        <input id="edit-po-${id}" value="${v.po_ref || ""}" style="
            width:100%; padding:10px; 
            background:#1c1c1c; color:#fff;
            border:1px solid #444; border-radius:6px; margin-bottom:16px;">

        <label style="color:#bbb;">Pager Number:</label>
        <input id="edit-pager-${id}" type="number" value="${v.pager_number || ""}" style="
            width:100%; padding:10px;
            background:#1c1c1c; color:#fff;
            border:1px solid #444; border-radius:6px; margin-bottom:16px;">

        <label style="color:#bbb;">Notes:</label>
        <textarea id="edit-notes-${id}" style="
            width:100%; height:90px; padding:10px;
            background:#1c1c1c; color:#fff;
            border:1px solid #444; border-radius:6px;">${v.notes || ""}</textarea>

        <div style="margin-top:22px; text-align:right;">
            <button onclick="closeModal()" style="
                padding:10px 18px; background:#555; color:white;
                border:none; border-radius:6px; margin-right:12px;">
                Cancel
            </button>

            <button onclick="saveModalEditor('${id}')" style="
                padding:10px 18px; background:#1b4cd4; color:white;
                border:none; border-radius:6px;">
                Save
            </button>
        </div>
    `;

    overlay.style.display = "block";
}

function closeModal() {
    document.getElementById("editModalOverlay").style.display = "none";
}
</script>
<!-- END D4 -->


<!-- START D5 -->
<script>
async function saveModalEditor(id) {
    const opId = localStorage.getItem("operator_id");

    const status = document.getElementById(`edit-status-${id}`).value;
    const po = document.getElementById(`edit-po-${id}`).value.trim();
    const pager = parseInt(document.getElementById(`edit-pager-${id}`).value);
    const notes = document.getElementById(`edit-notes-${id}`).value.trim();
    const now = new Date().toISOString();

    await db.from("vehicles").update({
        status,
        po_ref: po,
        pager_number: pager,
        notes,
        notify_time: status === "notified" ? now : null,
        release_time: status === "released" ? now : null,
        operator_id: opId
    }).eq("id", id);

    await db.from("actions_log").insert({
        vehicle_id: id,
        operator_id: opId,
        action: "modal_edit",
        details: { status, po, pager, notes }
    });

    closeModal();
    loadQueue();
    loadActivity();
    loadStats();
}
</script>
<!-- END D5 -->

<!-- END SECTION D -->

<!-- START SECTION E -->

<!-- START E1 -->
<script>
function updateClock() {
    const clock = document.getElementById("clock");
    if (!clock) return;

    const now = new Date();
    const hh = String(now.getHours()).padStart(2, "0");
    const mm = String(now.getMinutes()).padStart(2, "0");

    clock.textContent = `${hh}:${mm}`;
}
setInterval(updateClock, 1000);
updateClock();
</script>
<!-- END E1 -->


<!-- START E2 -->
<script>
async function autoRefresh() {
    await loadQueue();
    await loadActivity();
    await loadStats();
}
setInterval(autoRefresh, 30000); // every 30 seconds
</script>
<!-- END E2 -->


<!-- START E3 -->
<script>
window.onload = function() {
    updateClock();
    loadQueue();
    loadActivity();
    loadStats();
};
</script>
<!-- END E3 -->

<!-- END SECTION E -->
<!-- START END-OF-FILE -->
</body>
</html>
<!-- END END-OF-FILE -->

