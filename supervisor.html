<!-- START CHUNK S1 — Header + Styles -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supervisor Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    :root {
        --bg: #0d0d0d;
        --card: #1c1c1c;
        --text: #e6e6e6;
        --muted: #888;
        --accent: #1b8cff;
        --border: #303030;
    }

    body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font-family: Arial, sans-serif;
    }

    .header {
        background: #1b1b1b;
        padding: 20px 30px;
        font-size: 32px;
        font-weight: bold;
        border-bottom: 1px solid var(--border);
        color: var(--accent);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .grid-kpi {
        display: grid;
        grid-template-columns: repeat(4,1fr);
        gap: 20px;
        margin: 30px;
    }

    .kpi {
        background: var(--card);
        padding: 25px;
        border-radius: 12px;
        border: 1px solid var(--border);
        text-align: center;
    }
    .kpi .value {
        font-size: 42px;
        font-weight: bold;
        margin-bottom: 6px;
        color: var(--accent);
    }

    .charts {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 0 30px;
    }

    .chart-card {
        background: var(--card);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid var(--border);
    }

    .chart-card h3 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 20px;
        color: var(--text);
    }

    .tables {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 30px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: var(--card);
        border: 1px solid var(--border);
        font-size: 15px;
    }

    th, td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        color: var(--text);
    }
    th {
        background: #222;
        text-align: left;
        font-size: 14px;
        color: var(--muted);
    }
</style>
</head>
<body>

<div class="header">
    Supervisor Dashboard
    <span id="superName" style="font-size:16px;color:#fff;"></span>
</div>
<!-- END CHUNK S1 — Header + Styles -->

<!-- START CHUNK S6 — Supervisor Search + Dynamic Status Editor -->
<div style="padding:20px 30px;">
    <input 
        id="superSearch"
        type="text" 
        placeholder="Search by registration or PO…" 
        style="
            width:100%;
            padding:12px;
            font-size:18px;
            border-radius:8px;
            border:1px solid #333;
            background:#111;
            color:#eee;
        ">
</div>

<div id="superSearchResults" style="padding:0 30px; margin-bottom:20px;"></div>

<!-- Modal -->
<div id="superEditOverlay" style="
    position:fixed; top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.6);
    display:none; z-index:9999;">
    
    <div id="superEditModal" style="
        background:#1c1c1c;
        color:#fff;
        width:420px;
        margin:80px auto;
        padding:25px;
        border-radius:12px;
        border:1px solid #333;">
    </div>
</div>

<script>
// LIVE SEARCH
document.getElementById("superSearch").addEventListener("input", async (e) => {
    const q = e.target.value.trim().toUpperCase();
    const box = document.getElementById("superSearchResults");

    if (q.length < 2) {
        box.innerHTML = "";
        return;
    }

    let { data: results } = await db
        .from("vehicles")
        .select("*")
        .ilike("registration", `%${q}%`);

    if (!results.length) {
        const { data: byPO } = await db
            .from("vehicles")
            .select("*")
            .ilike("po_ref", `%${q}%`);
        results = byPO;
    }

    if (!results.length) {
        box.innerHTML = `<div style="color:#888;">No matches</div>`;
        return;
    }

    box.innerHTML = results.map(v => `
        <div onclick="superEditVehicle('${v.id}')"
            style="
                padding:12px;
                margin-bottom:8px;
                background:#1b1b1b;
                border:1px solid #333;
                border-radius:6px;
                cursor:pointer;">
            <strong>${v.registration}</strong> (${v.status})<br>
            PO: ${v.po_ref || "-"} | Pager: ${v.pager_number || "-"}
        </div>
    `).join("");
});

// OPEN MODAL EDITOR
async function superEditVehicle(id) {
    const { data: v } = await db
        .from("vehicles")
        .select("*")
        .eq("id", id)
        .single();

    const modal = document.getElementById("superEditModal");
    const overlay = document.getElementById("superEditOverlay");

    modal.innerHTML = `
        <h2>Edit ${v.registration}</h2>

        <label>Status</label>
        <select id="sv-status" style="
            width:100%; padding:10px; margin-bottom:12px;
            background:#222; border:1px solid #444; border-radius:6px; color:#fff;">
        </select>

        <label>PO / Reference</label>
        <input id="sv-po" value="${v.po_ref || ""}" style="
            width:100%; padding:10px; margin-bottom:12px;
            background:#222; border:1px solid #444; border-radius:6px; color:#fff;">

        <label>Pager Number</label>
        <input id="sv-pager" type="number" value="${v.pager_number || ""}" style="
            width:100%; padding:10px; margin-bottom:12px;
            background:#222; border:1px solid #444; border-radius:6px; color:#fff;">

        <label>Notes</label>
        <textarea id="sv-notes" style="
            width:100%; height:80px; padding:10px;
            background:#222; border:1px solid #444; border-radius:6px; color:#fff;
        ">${v.notes || ""}</textarea>

        <div style="margin-top:18px; text-align:right;">
            <button onclick="svClose()" style="
                padding:10px 16px; background:#555; color:white;
                border:none; border-radius:6px; margin-right:12px;">
                Cancel
            </button>

            <button onclick="svSave('${id}')" style="
                padding:10px 16px; background:#1b8cff; color:white;
                border:none; border-radius:6px;">
                Save
            </button>
        </div>
    `;

    overlay.style.display = "block";

    // Load status list dynamically
    loadStatusOptions("sv-status", v.status);
}

function svClose() {
    document.getElementById("superEditOverlay").style.display = "none";
}

// Dynamic status loader from DB
async function loadStatusOptions(selectId, current) {
    const { data: statuses } = await db
        .from("statuses")
        .select("name")
        .order("name");

    const sel = document.getElementById(selectId);
    sel.innerHTML = "";

    statuses.forEach(s => {
        sel.innerHTML += `
            <option value="${s.name}" ${current === s.name ? "selected" : ""}>
                ${s.name}
            </option>
        `;
    });
}

// SAVE EDITS
async function svSave(id) {
    const status = document.getElementById("sv-status").value;
    const po = document.getElementById("sv-po").value.trim();
    const pager = parseInt(document.getElementById("sv-pager").value);
    const notes = document.getElementById("sv-notes").value.trim();
    const opId = localStorage.getItem("operator_id");
    const now = new Date().toISOString();

    await db.from("vehicles").update({
        status,
        po_ref: po,
        pager_number: pager,
        notes,
        notify_time: (status==="notified" ? now : null),
        release_time: (status==="released" ? now : null),
        operator_id: opId
    }).eq("id", id);

    await db.from("actions_log").insert({
        vehicle_id: id,
        operator_id: opId,
        action: "supervisor_edit",
        details: { status, po, pager, notes }
    });

    svClose();
}
</script>
<!-- END CHUNK S6 — Supervisor Search + Dynamic Status Editor -->


<!-- START CHUNK S2 — KPI + Charts + Tables -->

<!-- KPI ROW -->
<div class="grid-kpi">
    <div class="kpi"><div class="value" id="kpiLorriesToday">0</div>Lorries Today</div>
    <div class="kpi"><div class="value" id="kpiReleased">0</div>Completed Today</div>
    <div class="kpi"><div class="value" id="kpiAvgWait">0 mins</div>Avg Active Wait</div>
    <div class="kpi"><div class="value" id="kpiOverdue">0</div>Overdue > 1hr</div>
</div>

<!-- CHARTS -->
<div class="charts">
    <div class="chart-card">
        <h3>Check-ins Per Hour</h3>
        <canvas id="chartCheckins"></canvas>
    </div>

    <div class="chart-card">
        <h3>Overdue Buckets</h3>
        <canvas id="chartOverdueBuckets"></canvas>
    </div>
</div>

<!-- TABLES -->
<div class="tables">
    <div>
        <h3 style="margin-left:5px;">Top 10 Longest Waits</h3>
        <table id="tblWaits">
            <tr><th>Reg</th><th>Wait</th><th>PO</th></tr>
        </table>
    </div>

    <div>
        <h3 style="margin-left:5px;">Recent Activity</h3>
        <table id="tblActivity">
            <tr><th>Time</th><th>Event</th></tr>
        </table>
    </div>
</div>

<!-- END CHUNK S2 — KPI + Charts + Tables -->

<!-- START CHUNK S3 — Supabase + Access Check -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const db = supabase.createClient(
    "https://splcucorowqjxeeseolq.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwbGN1Y29yb3dxanhlZXNlb2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTExMjUsImV4cCI6MjA3ODYyNzEyNX0.R-Fm04UtBOr9OBWHnS1fhk6SnfSm7f3ZrFrQdzO1Q4Y"
);

// CHECK SUPERVISOR ROLE
(async () => {
    const opId = localStorage.getItem("operator_id");
    if (!opId) {
        window.location.href = "login.html";
        return;
    }

    const { data: op } = await db
        .from("operators")
        .select("name, role")
        .eq("id", opId)
        .single();

    if (!op || op.role !== "supervisor") {
        window.location.href = "index.html";
        return;
    }

    document.getElementById("superName").textContent = op.name;
})();
</script>

<!-- END CHUNK S3 — Supabase + Access Check -->

<!-- START CHUNK S4 — KPI + Tables + Charts Logic -->

<script>
async function loadKPIs() {
    const today = new Date().toISOString().slice(0,10);

    const { data: inToday } = await db
        .from("vehicles").select("id")
        .gte("check_in_time", today);

    const { data: releasedToday } = await db
        .from("vehicles").select("id")
        .eq("status","released")
        .gte("release_time", today);

    const { data: waiting } = await db
        .from("vehicles").select("check_in_time")
        .eq("status","waiting");

    const { data: active } = await db
        .from("vehicles").select("due_time")
        .in("status", ["waiting","notified"]);

    let overdue = 0;
    const now = Date.now();
    active.forEach(v => {
        const due = new Date(v.due_time).getTime();
        if (now - due > 60*60000) overdue++;
    });

    let avgWait = 0;
    if (waiting.length > 0) {
        const total = waiting.reduce((sum,v) =>
            sum + (Date.now() - new Date(v.check_in_time)), 0);
        avgWait = Math.floor(total / waiting.length / 60000);
    }

    document.getElementById("kpiLorriesToday").textContent = inToday.length;
    document.getElementById("kpiReleased").textContent = releasedToday.length;
    document.getElementById("kpiAvgWait").textContent = `${avgWait} mins`;
    document.getElementById("kpiOverdue").textContent = overdue;
}

async function loadTopWaits() {
    const tbl = document.getElementById("tblWaits");
    tbl.innerHTML = `<tr><th>Reg</th><th>Wait</th><th>PO</th></tr>`;

    const { data } = await db
        .from("vehicles")
        .select("registration, po_ref, check_in_time")
        .eq("status", "waiting");

    if (!data.length) {
        tbl.innerHTML += `<tr><td colspan="3">No active waits</td></tr>`;
        return;
    }

    const ranked = data
        .map(v => ({
            ...v,
            wait: Math.floor((Date.now() - new Date(v.check_in_time)) / 60000)
        }))
        .sort((a,b) => b.wait - a.wait)
        .slice(0,10);

    ranked.forEach(v => {
        tbl.innerHTML += `
            <tr>
                <td>${v.registration}</td>
                <td>${v.wait} mins</td>
                <td>${v.po_ref || "-"}</td>
            </tr>`;
    });
}

async function loadActivity() {
    const tbl = document.getElementById("tblActivity");
    tbl.innerHTML = `<tr><th>Time</th><th>Event</th></tr>`;

    const { data } = await db
        .from("actions_log")
        .select("timestamp, action, operators(name), vehicles(registration)")
        .order("timestamp", { ascending: false })
        .limit(10);

    if (!data.length) {
        tbl.innerHTML += `<tr><td colspan="2">No activity</td></tr>`;
        return;
    }

    data.forEach(a => {
        const t = new Date(a.timestamp)
            .toLocaleTimeString("en-GB", { hour:"2-digit", minute:"2-digit" });

        tbl.innerHTML += `
            <tr>
                <td>${t}</td>
                <td>${a.action} – ${a.vehicles?.registration || "?"} by ${a.operators?.name}</td>
            </tr>`;
    });
}

let chart1 = null;
let chartBuckets = null;

async function loadCharts() {
    const { data: checkins } = await db
        .from("vehicles")
        .select("check_in_time");

    const buckets = {};
    checkins.forEach(v => {
        const hour = new Date(v.check_in_time).getHours();
        buckets[hour] = (buckets[hour] || 0) + 1;
    });

    if (chart1) chart1.destroy();

    chart1 = new Chart(document.getElementById("chartCheckins"), {
        type: "line",
        data: {
            labels: Object.keys(buckets),
            datasets: [{
                label: "Check-ins",
                data: Object.values(buckets),
                borderColor: "#1b8cff",
                backgroundColor: "transparent",
                borderWidth: 2
            }]
        }
    });

    const { data: active } = await db
        .from("vehicles")
        .select("due_time")
        .in("status", ["waiting","notified"]);

    let b0_30=0, b30_60=0, b60_120=0, b120plus=0;
    const now = Date.now();

    active.forEach(v => {
        const due = new Date(v.due_time).getTime();
        const minutes = Math.floor((now - due) / 60000);

        if (minutes < 0) { b0_30++; return; }
        if (minutes < 30) b0_30++;
        else if (minutes < 60) b30_60++;
        else if (minutes < 120) b60_120++;
        else b120plus++;
    });

    const labels = ["0–30m","30–60m","60–120m","120+m"];
    const values = [b0_30, b30_60, b60_120, b120plus];
    const colours = ["#46d369","#ffb300","#ff6f3c","#d32f2f"];

    if (chartBuckets) chartBuckets.destroy();

    chartBuckets = new Chart(document.getElementById("chartOverdueBuckets"), {
        type: "bar",
        data: { labels, datasets: [{ data: values, backgroundColor: colours }] },
        options: { scales:{ y:{ beginAtZero:true } } }
    });
}

function runAll() {
    loadKPIs();
    loadTopWaits();
    loadActivity();
    loadCharts();
}
runAll();
setInterval(runAll, 30000);
</script>

<!-- END CHUNK S4 — KPI + Tables + Charts Logic --><!-- START CHUNK S5 — Closing HTML -->
</body>
</html>
<!-- END CHUNK S5 — Closing HTML -->


